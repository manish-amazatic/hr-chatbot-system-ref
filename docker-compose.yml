services:
  # Milvus Vector Database
  milvus:
    image: milvusdb/milvus:v2.3.3
    container_name: hr-milvus
    security_opt:
      - seccomp:unconfined
    environment:
      ETCD_USE_EMBED: "true"
      ETCD_DATA_DIR: /var/lib/milvus/etcd
      COMMON_STORAGETYPE: local
    ports:
      - "19530:19530"
      - "9091:9091"
    volumes:
      - milvus_data:/var/lib/milvus
    command: ["milvus", "run", "standalone"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - hr-network

  # HRMS Mock API Service
  hrms-mock-api:
    build:
      context: ./services/hrms-mock-api
      dockerfile: Dockerfile
    container_name: hr-hrms-mock-api
    environment:
      - DATABASE_URL=sqlite:///./data/hrms.db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=1440
      - LOG_LEVEL=info
    ports:
      - "8001:8000"
    volumes:
      - hrms_data:/app/data
      - ./services/hrms-mock-api:/app
    command: uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - hr-network

  # HR Chatbot Service
  hr-chatbot-service:
    build:
      context: ./services/hr-chatbot-service
      dockerfile: Dockerfile
    container_name: hr-chatbot-service
    environment:
      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
      - LLM_MODEL=${LLM_MODEL:-gpt-4o-mini}

      # Milvus
      - MILVUS_URI=http://milvus:19530
      - MILVUS_COLLECTION_NAME=${MILVUS_COLLECTION_NAME:-hr_policies}

      # HRMS API
      - HRMS_API_URL=http://hrms-mock-api:8000

      # JWT
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=HS256

      # Database (for sessions)
      - DATABASE_URL=sqlite:///./data/chatbot.db

      # Other
      - LOG_LEVEL=info
    ports:
      - "8000:8000"
    depends_on:
      milvus:
        condition: service_healthy
      hrms-mock-api:
        condition: service_healthy
    volumes:
      - chatbot_data:/app/data
      - ./services/hr-chatbot-service:/app
    command: uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - hr-network

  # HR Chatbot UI
  hr-chatbot-ui:
    build:
      context: ./services/hr-chatbot-ui
      dockerfile: Dockerfile
      target: development
    container_name: hr-chatbot-ui
    environment:
      - VITE_API_URL=http://localhost:8000
      - VITE_HRMS_API_URL=http://localhost:8001
    ports:
      - "3000:3000"
    depends_on:
      - hr-chatbot-service
    volumes:
      - ./services/hr-chatbot-ui:/app
      - /app/node_modules
    command: npm run dev -- --host 0.0.0.0
    networks:
      - hr-network

volumes:
  milvus_data:
    driver: local
  hrms_data:
    driver: local
  chatbot_data:
    driver: local

networks:
  hr-network:
    driver: bridge
