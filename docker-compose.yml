services:
  # Milvus Vector Database
  milvus:
    image: milvusdb/milvus:v2.3.3
    container_name: hr-milvus
    security_opt:
      - seccomp:unconfined
    environment:
      ETCD_USE_EMBED: "true"
      ETCD_DATA_DIR: /var/lib/milvus/etcd
      COMMON_STORAGETYPE: local
    ports:
      - "19530:19530"
      - "9091:9091"
    volumes:
      - milvus_data:/var/lib/milvus
    command: ["milvus", "run", "standalone"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - hr-network

  # HR Chatbot Service
  hr-chatbot-service:
    build:
      context: ./services/hr-chatbot-service
      dockerfile: Dockerfile
    container_name: hr-chatbot-service
    environment:
      # LLM Provider Configuration
      - LLM_PROVIDER=${LLM_PROVIDER}
      - LLM_MODEL=${LLM_MODEL}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE}

      # Embedding Provider Configuration
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL}
      - EMBEDDING_DIMENSIONS=${EMBEDDING_DIMENSIONS}

      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY}

      # Google
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GOOGLE_PROJECT_ID=${GOOGLE_PROJECT_ID}
      - GOOGLE_LOCATION=${GOOGLE_LOCATION}

      # Anthropic
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # Azure
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AZURE_OPENAI_API_VERSION=${AZURE_OPENAI_API_VERSION}
      - AZURE_OPENAI_DEPLOYMENT_NAME=${AZURE_OPENAI_DEPLOYMENT_NAME}
      - AZURE_OPENAI_EMBEDDING_DEPLOYMENT_NAME=${AZURE_OPENAI_EMBEDDING_DEPLOYMENT_NAME}

      # Ollama
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL}

      # Milvus
      - MILVUS_URI=http://milvus:19530
      - MILVUS_COLLECTION_NAME=${MILVUS_COLLECTION_NAME:-hr_policies}

      # Other
      - LOG_LEVEL=info
    ports:
      - "8000:8000"
    depends_on:
      milvus:
        condition: service_healthy
    volumes:
      - ./services/hr-chatbot-service:/app
    command: uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - hr-network

  # HR Chatbot UI
  hr-chatbot-ui:
    build:
      context: ./services/hr-chatbot-ui
      dockerfile: Dockerfile
      target: development
    container_name: hr-chatbot-ui
    environment:
      - VITE_API_URL=http://localhost:8000
    ports:
      - "3000:3000"
    depends_on:
      - hr-chatbot-service
    volumes:
      - ./services/hr-chatbot-ui:/app
      - /app/node_modules
    command: npm run dev -- --host 0.0.0.0
    networks:
      - hr-network

volumes:
  milvus_data:
    driver: local

networks:
  hr-network:
    driver: bridge
